<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Dashboard</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 16px;
    background: #111;
    color: #eee;
  }

  .card {
    background: #1e1e1e;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .tv {
    height: 500px;
  }

  /* 横スワイプ */
  .chart-slider {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    gap: 16px;
  }

  .slide {
    min-width: 100%;
    scroll-snap-align: start;
  }

  /* スクロールバー非表示（iOS向け） */
  .chart-slider::-webkit-scrollbar {
    display: none;
  }
</style>
</head>

<body>
<h1>Crypto Dashboard</h1>

<div class="chart-slider">
  <div class="slide">
    <div class="card">
      <h2>BTC / JPY</h2>
      <div id="tv_btc" class="tv"></div>
    </div>
  </div>

  <div class="slide">
    <div class="card">
      <h2>ETH / JPY</h2>
      <div id="tv_eth" class="tv"></div>
    </div>
  </div>
</div>

<!-- TradingView 読み込みは1回だけ -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  new TradingView.widget({
    container_id: "tv_btc",
    symbol: "BITFLYER:BTCJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  new TradingView.widget({
    container_id: "tv_eth",
    symbol: "BITFLYER:ETHJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });
});
</script>

<div class="card">
  <h2>Fear & Greed Index</h2>
  <div id="fear">Loading...</div>
</div>

<script>
async function loadFearGreed() {
  try {
    const response = await fetch("https://api.alternative.me/fng/?limit=1&format=json");
    const data = await response.json();

    const value = parseInt(data.data[0].value);
    const text = data.data[0].value_classification;

    let color = "#999";
    if (value <= 25) color = "#2ecc71";
    else if (value <= 50) color = "#f1c40f";
    else if (value <= 75) color = "#e67e22";
    else color = "#e74c3c";

    document.getElementById("fear").innerHTML =
      `<div style="
        background:${color};
        color:white;
        padding:20px;
        border-radius:12px;
        font-size:28px;
        text-align:center;">
        ${value} - ${text}
      </div>`;
  } catch (e) {
    document.getElementById("fear").innerHTML = "<p>Fear & Greed Index could not load.</p>";
  }
}
loadFearGreed();
</script>

<div class="card">
  <h2>BTC RSI (1h)</h2>
  <div id="rsi_btc">Loading...</div>
</div>

<script>
async function loadRSI() {
  try {
    const response = await fetch(
      "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=jpy&days=2&interval=hourly"
    );
    const data = await response.json();
    const prices = data.prices.map(p => p[1]);

    function calculateRSI(prices, period = 14) {
      let gains = 0, losses = 0;
      for (let i = prices.length - period; i < prices.length; i++) {
        const diff = prices[i] - prices[i - 1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period;
      const rs = avgLoss === 0 ? 999 : (avgGain / avgLoss);
      return 100 - (100 / (1 + rs));
    }

    const rsi = calculateRSI(prices);
    const rsiRounded = rsi.toFixed(1);

    let color = "#888";
    if (rsi < 30) color = "#2ecc71";
    else if (rsi > 70) color = "#e74c3c";

    document.getElementById("rsi_btc").innerHTML =
      `<div style="
        background:${color};
        color:white;
        padding:20px;
        border-radius:12px;
        font-size:28px;
        text-align:center;">
        ${rsiRounded}
      </div>`;
  } catch (e) {
    document.getElementById("rsi_btc").innerHTML = "<p>RSI load failed</p>";
  }
}
loadRSI();
</script>

</body>
</html>
