<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Dashboard</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 16px;
    background: #111;
    color: #eee;
  }

  .card {
    background: #1e1e1e;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .tv {
    height: 500px;
  }

  .chart-slider {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    gap: 16px;
  }

  .slide {
    min-width: 100%;
    scroll-snap-align: start;
  }

  .chart-slider::-webkit-scrollbar {
    display: none;
  }
</style>
</head>

<body>
<h1>Crypto Dashboard</h1>

<div class="chart-slider">
  <div class="slide">
    <div class="card">
      <h2>BTC / JPY</h2>
      <div id="tv_btc" class="tv"></div>
    </div>
  </div>

  <div class="slide">
    <div class="card">
      <h2>ETH / JPY</h2>
      <div id="tv_eth" class="tv"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Fear & Greed Index</h2>
  <div id="fear">Loading...</div>
</div>

<div class="card">
  <h2>Today Signal</h2>
  <div id="signal">Loading...</div>
</div>

<div class="card">
  <h2>noteÁî®„É°„É¢</h2>
  <textarea id="noteText" rows="6" style="width:100%; border-radius:12px; padding:12px; background:#111; color:#eee; border:1px solid #333;"></textarea>
  <div style="display:flex; gap:12px; margin-top:12px;">
    <button id="genBtn" style="flex:1; padding:12px; border-radius:12px; background:#2d6cdf; color:white; border:none;">ÁîüÊàê</button>
    <button id="copyBtn" style="flex:1; padding:12px; border-radius:12px; background:#444; color:white; border:none;">„Ç≥„Éî„Éº</button>
  </div>
  <div id="copyStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></div>
</div>

<!-- TradingView Ë™≠„ÅøËæº„Åø„ÅØ1Âõû„Å†„Åë -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
/* ===== „Ç∞„É≠„Éº„Éê„É´‰øùÂ≠òÔºà„Åì„Åì„Åß1Âõû„Å†„ÅëÂÆöÁæ©Ôºâ ===== */
window.latestFearValue = null;
window.latestFearText = null;

document.addEventListener("DOMContentLoaded", function () {

  // TradingView
  new TradingView.widget({
    container_id: "tv_btc",
    symbol: "BITFLYER:BTCJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  new TradingView.widget({
    container_id: "tv_eth",
    symbol: "BITFLYER:ETHJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  loadFearGreed();

  // noteÁî®„Éú„Çø„É≥
  document.getElementById("genBtn").addEventListener("click", generateNoteText);
  document.getElementById("copyBtn").addEventListener("click", copyNoteText);
});

async function loadFearGreed() {
  const fearEl = document.getElementById("fear");
  const signalEl = document.getElementById("signal");

  try {
    const url = "https://api.alternative.me/fng/?limit=1&format=json";
    const response = await fetch(url, { cache: "no-store" });

    if (!response.ok) throw new Error("HTTP " + response.status);

    const data = await response.json();
    if (!data || !data.data || !data.data[0]) throw new Error("Invalid API response");

    const value = parseInt(data.data[0].value);
    const text = data.data[0].value_classification;

    // noteÁî®„Å´‰øùÂ≠ò
    window.latestFearValue = value;
    window.latestFearText = text;

    let color = "#999";
    if (value <= 25) color = "#2ecc71";
    else if (value <= 50) color = "#f1c40f";
    else if (value <= 75) color = "#e67e22";
    else color = "#e74c3c";

    // FearË°®Á§∫
    fearEl.innerHTML = `
      <div style="background:${color};color:white;padding:20px;border-radius:12px;font-size:28px;text-align:center;">
        ${value} - ${text}
      </div>
    `;

    // Today Signal
    let signalText = "";
    let signalColor = "#888";

    if (value <= 25) {
      signalText = "üü¢ OpportunityÔºàÂ∏ÇÂ†¥„ÅØÊÅêÊÄñÂØÑ„ÇäÔºâ";
      signalColor = "#2ecc71";
    } else if (value <= 50) {
      signalText = "üü° NeutralÔºàÊßòÂ≠êË¶ãÔºâ";
      signalColor = "#f1c40f";
    } else if (value <= 75) {
      signalText = "üü† GreedÔºàÈÅéÁÜ±Ê≥®ÊÑèÔºâ";
      signalColor = "#e67e22";
    } else {
      signalText = "üî¥ RiskyÔºàÂà©Á¢∫Ë≠¶ÊàíÔºâ";
      signalColor = "#e74c3c";
    }

    signalEl.innerHTML = `
      <div style="background:${signalColor};color:white;padding:20px;border-radius:12px;font-size:20px;text-align:center;">
        ${signalText}
      </div>
    `;

  } catch (e) {
    fearEl.innerHTML = `<p style="color:red;">Fear load failed: ${String(e)}</p>`;
    signalEl.innerHTML = `<p style="color:red;">Signal load failed</p>`;
  }
}

function classifyFear(value) {
  if (value <= 25) return "ÊÅêÊÄñÔºà„ÉÅ„É£„É≥„ÇπÂØÑ„ÇäÔºâ";
  if (value <= 50) return "„ÇÑ„ÇÑÊÅêÊÄñ„Äú‰∏≠Á´ã";
  if (value <= 75) return "Âº∑Ê¨≤Ê∞óÂë≥ÔºàÈÅéÁÜ±Ê≥®ÊÑèÔºâ";
  return "Âº∑Ê¨≤ÔºàË≠¶ÊàíÔºâ";
}

function generateNoteText() {
  const v = window.latestFearValue;
  const t = window.latestFearText;

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");

  const fearLine = (v === null)
    ? "ÊÅêÊÄñÊåáÊï∞ÔºöÂèñÂæó„Åß„Åç„Åö"
    : `ÊÅêÊÄñÊåáÊï∞Ôºö${v}Ôºà${t} / ${classifyFear(v)}Ôºâ`;

  const text =
    `„Äê${y}/${m}/${d}„Äë\n` +
    `BTC/ETHÔºö„ÉÅ„É£„Éº„ÉàÁ¢∫Ë™çÔºà1ÊôÇÈñìË∂≥Ôºâ\n` +
    `${fearLine}\n` +
    `‰ªäÊó•„ÅÆ„É°„É¢Ôºö\n` +
    `„Éª`;

  document.getElementById("noteText").value = text;
}

async function copyNoteText() {
  const area = document.getElementById("noteText");
  const status = document.getElementById("copyStatus");

  try {
    await navigator.clipboard.writeText(area.value);
    status.textContent = "„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü ‚úÖ";
  } catch (e) {
    area.focus();
    area.select();
    status.textContent = "Ëá™Âãï„Ç≥„Éî„Éº„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÈÅ∏Êäû„Åó„Å¶ÊâãÂãï„Ç≥„Éî„Éº„Åó„Å¶„Å≠";
  }
}
</script>

</body>
</html>
