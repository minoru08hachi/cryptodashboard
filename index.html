<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Dashboard</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 16px;
    background: #111;
    color: #eee;
  }

  .card {
    background: #1e1e1e;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .tv { height: 500px; }

  /* æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰ */
  .chart-slider {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    gap: 16px;
  }
  .slide {
    min-width: 100%;
    scroll-snap-align: start;
  }
  .chart-slider::-webkit-scrollbar { display: none; }

  /* News tabs */
  .news-tabs{
    display:flex;
    gap:8px;
    margin:10px 0 12px;
  }
  .news-tabs .tab{
    flex:1;
    padding:10px;
    border-radius:12px;
    border:1px solid #333;
    background:#222;
    color:#eee;
  }
  .news-tabs .tab.active{
    border-color:#2d6cdf;
    background:#1c2b4a;
  }
  .news-frame-wrap{
    height:520px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #333;
  }
  .news-frame{
    width:100%;
    height:100%;
    border:0;
    background:#111;
  }
  .news-hint{
    margin-top:10px;
    font-size:12px;
    opacity:0.85;
  }

  /* note textarea */
  .note-area{
    width:100%;
    border-radius:12px;
    padding:12px;
    background:#111;
    color:#eee;
    border:1px solid #333;
  }
  .btn-row{
    display:flex;
    gap:12px;
    margin-top:12px;
  }
  .btn{
    flex:1;
    padding:12px;
    border-radius:12px;
    border:none;
    color:white;
  }
  .btn-primary{ background:#2d6cdf; }
  .btn-secondary{ background:#444; }
</style>
</head>

<body>
<h1>Crypto Dashboard</h1>

<!-- ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰ -->
<div class="chart-slider">
  <div class="slide">
    <div class="card">
      <h2>BTC / JPY</h2>
      <div id="tv_btc" class="tv"></div>
    </div>
  </div>

  <div class="slide">
    <div class="card">
      <h2>ETH / JPY</h2>
      <div id="tv_eth" class="tv"></div>
    </div>
  </div>
</div>

<!-- Fear & Greed -->
<div class="card">
  <h2>Fear & Greed Index</h2>
  <div id="fear">Loading...</div>
</div>

<!-- Signal -->
<div class="card">
  <h2>Today Signal</h2>
  <div id="signal">Loading...</div>
</div>

<!-- noteç”¨ãƒ¡ãƒ¢ -->
<div class="card">
  <h2>noteç”¨ãƒ¡ãƒ¢</h2>
  <textarea id="noteText" rows="6" class="note-area"></textarea>
  <div class="btn-row">
    <button id="genBtn" class="btn btn-primary">ç”Ÿæˆ</button>
    <button id="copyBtn" class="btn btn-secondary">ã‚³ãƒ”ãƒ¼</button>
  </div>
  <div id="copyStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></div>
</div>

<!-- Newsï¼ˆåŸ‹ã‚è¾¼ã¿ï¼‰ -->
<div class="card">
  <h2>Newsï¼ˆã‚¢ãƒ—ãƒªå†…è¡¨ç¤ºï¼‰</h2>

  <div class="news-tabs">
    <button class="tab active" data-src="https://www.coindesk.com/">CoinDesk</button>
    <button class="tab" data-src="https://cointelegraph.com/">Cointelegraph</button>
    <button class="tab" data-src="https://www.theblock.co/">The Block</button>
  </div>

  <div class="news-frame-wrap">
    <iframe id="newsFrame" class="news-frame" src="https://www.coindesk.com/"></iframe>
  </div>

  <div id="newsHint" class="news-hint"></div>
</div>

<!-- TradingView èª­ã¿è¾¼ã¿ -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
/* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜ ===== */
window.latestFearValue = null;
window.latestFearText = null;

document.addEventListener("DOMContentLoaded", function () {
  // 1) TradingView widgets
  new TradingView.widget({
    container_id: "tv_btc",
    symbol: "BITFLYER:BTCJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  new TradingView.widget({
    container_id: "tv_eth",
    symbol: "BITFLYER:ETHJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  // 2) Fear & Greed + Signal
  loadFearGreed();

  // 3) noteãƒœã‚¿ãƒ³
  document.getElementById("genBtn").addEventListener("click", generateNoteText);
  document.getElementById("copyBtn").addEventListener("click", copyNoteText);

  // 4) News tabs
  setupNewsTabs();
});

async function loadFearGreed() {
  const fearEl = document.getElementById("fear");
  const signalEl = document.getElementById("signal");

  try {
    const url = "https://api.alternative.me/fng/?limit=1&format=json";
    const response = await fetch(url, { cache: "no-store" });

    if (!response.ok) throw new Error("HTTP " + response.status);

    const data = await response.json();
    if (!data || !data.data || !data.data[0]) throw new Error("Invalid API response");

    const value = parseInt(data.data[0].value);
    const text = data.data[0].value_classification;

    window.latestFearValue = value;
    window.latestFearText = text;

    let color = "#999";
    if (value <= 25) color = "#2ecc71";
    else if (value <= 50) color = "#f1c40f";
    else if (value <= 75) color = "#e67e22";
    else color = "#e74c3c";

    fearEl.innerHTML = `
      <div style="background:${color};color:white;padding:20px;border-radius:12px;font-size:28px;text-align:center;">
        ${value} - ${text}
      </div>
    `;

    let signalText = "";
    let signalColor = "#888";

    if (value <= 25) {
      signalText = "ğŸŸ¢ Opportunityï¼ˆå¸‚å ´ã¯ææ€–å¯„ã‚Šï¼‰";
      signalColor = "#2ecc71";
    } else if (value <= 50) {
      signalText = "ğŸŸ¡ Neutralï¼ˆæ§˜å­è¦‹ï¼‰";
      signalColor = "#f1c40f";
    } else if (value <= 75) {
      signalText = "ğŸŸ  Greedï¼ˆéç†±æ³¨æ„ï¼‰";
      signalColor = "#e67e22";
    } else {
      signalText = "ğŸ”´ Riskyï¼ˆåˆ©ç¢ºè­¦æˆ’ï¼‰";
      signalColor = "#e74c3c";
    }

    signalEl.innerHTML = `
      <div style="background:${signalColor};color:white;padding:20px;border-radius:12px;font-size:20px;text-align:center;">
        ${signalText}
      </div>
    `;

  } catch (e) {
    fearEl.innerHTML = `<p style="color:red;">Fear load failed: ${String(e)}</p>`;
    signalEl.innerHTML = `<p style="color:red;">Signal load failed</p>`;
  }
}

function classifyFear(value) {
  if (value <= 25) return "ææ€–ï¼ˆãƒãƒ£ãƒ³ã‚¹å¯„ã‚Šï¼‰";
  if (value <= 50) return "ã‚„ã‚„ææ€–ã€œä¸­ç«‹";
  if (value <= 75) return "å¼·æ¬²æ°—å‘³ï¼ˆéç†±æ³¨æ„ï¼‰";
  return "å¼·æ¬²ï¼ˆè­¦æˆ’ï¼‰";
}

function generateNoteText() {
  const v = window.latestFearValue;
  const t = window.latestFearText;

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");

  const fearLine = (v === null)
    ? "ææ€–æŒ‡æ•°ï¼šå–å¾—ã§ããš"
    : `ææ€–æŒ‡æ•°ï¼š${v}ï¼ˆ${t} / ${classifyFear(v)}ï¼‰`;

  const text =
    `ã€${y}/${m}/${d}ã€‘\n` +
    `BTC/ETHï¼šãƒãƒ£ãƒ¼ãƒˆç¢ºèªï¼ˆ1æ™‚é–“è¶³ï¼‰\n` +
    `${fearLine}\n` +
    `ä»Šæ—¥ã®ãƒ¡ãƒ¢ï¼š\n` +
    `ãƒ»`;

  document.getElementById("noteText").value = text;
}

async function copyNoteText() {
  const area = document.getElementById("noteText");
  const status = document.getElementById("copyStatus");

  try {
    await navigator.clipboard.writeText(area.value);
    status.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
  } catch (e) {
    area.focus();
    area.select();
    status.textContent = "è‡ªå‹•ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€é¸æŠã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ã­";
  }
}

function setupNewsTabs(){
  const tabs = document.querySelectorAll(".news-tabs .tab");
  const frame = document.getElementById("newsFrame");
  const hint = document.getElementById("newsHint");

  if (!tabs.length || !frame) return;

  function setActive(btn){
    tabs.forEach(t => t.classList.remove("active"));
    btn.classList.add("active");
  }

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      setActive(btn);
      const url = btn.getAttribute("data-src");
      hint.textContent = "Loading...";
      frame.src = url;

      setTimeout(() => {
        hint.textContent = "çœŸã£ç™½ãªã‚‰ã€ãã®ã‚µã‚¤ãƒˆã¯åŸ‹ã‚è¾¼ã¿ç¦æ­¢ã§ã™ã€‚æ¬¡ã®æ®µéšã§ã€è¦ç´„è¡¨ç¤ºï¼‹åŒã‚¢ãƒ—ãƒªå†…ã§é–‹ãã€ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚";
      }, 1500);
    });
  });
}
</script>

</body>
</html>
