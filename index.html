<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Dashboard</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 16px;
    background: #111;
    color: #eee;
  }
  .card {
    background: #1e1e1e;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  .tv { height: 500px; }

  /* æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰ */
  .chart-slider {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    gap: 16px;
  }
  .slide {
    min-width: 100%;
    scroll-snap-align: start;
  }
  .chart-slider::-webkit-scrollbar { display: none; }

  /* note textarea */
  .note-area{
    width:100%;
    border-radius:12px;
    padding:12px;
    background:#111;
    color:#eee;
    border:1px solid #333;
  }
  .btn-row{
    display:flex;
    gap:12px;
    margin-top:12px;
  }
  .btn{
    flex:1;
    padding:12px;
    border-radius:12px;
    border:none;
    color:white;
    cursor:pointer;
  }
  .btn-primary{ background:#2d6cdf; }
  .btn-secondary{ background:#444; }
  .btn-tertiary{ background:#2b2b2b; border:1px solid #3a3a3a; }

  /* News (RSS reader) */
  .news-toolbar{
    display:flex;
    gap:10px;
    margin:10px 0 12px;
  }
  .news-toolbar button{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #333;
    background:#222;
    color:#eee;
    flex:1;
    cursor:pointer;
  }
  .news-status{
    font-size:12px;
    opacity:0.85;
    margin-top:8px;
  }
  .news-list{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:10px;
  }
  .news-item{
    border:1px solid #333;
    border-radius:12px;
    padding:10px;
    background:#141414;
  }
  .news-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #333;
    background:#1f1f1f;
    opacity:0.95;
    white-space:nowrap;
  }
  .news-title{
    font-weight:700;
    line-height:1.35;
    margin:0;
  }
  .news-title a{
    color:#e9f1ff;
    text-decoration:none;
  }
  .news-title a:visited{
    color:#c9d7ff;
  }
  .news-desc{
    font-size:13px;
    opacity:0.92;
    line-height:1.55;
    margin-top:6px;
  }
  .news-meta{
    font-size:11px;
    opacity:0.75;
    margin-top:8px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .news-memo{
    width:100%;
    margin-top:10px;
    border-radius:12px;
    padding:10px;
    background:#101010;
    color:#eee;
    border:1px solid #333;
    font-size:13px;
  }
  .news-pick{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:10px;
    font-size:12px;
    opacity:0.9;
  }

  /* Debug */
  .debug-box{
    margin-top:10px;
    border:1px solid #333;
    border-radius:12px;
    background:#0f0f0f;
    padding:10px;
    font-size:12px;
    line-height:1.5;
    opacity:0.95;
    white-space:pre-wrap;
  }
  .row{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:10px;
  }
  .row .btn{ flex:1; }
</style>
</head>

<body>
<h1>Crypto Dashboard</h1>

<!-- ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰ -->
<div class="chart-slider">
  <div class="slide">
    <div class="card">
      <h2>BTC / JPY</h2>
      <div id="tv_btc" class="tv"></div>
    </div>
  </div>
  <div class="slide">
    <div class="card">
      <h2>ETH / JPY</h2>
      <div id="tv_eth" class="tv"></div>
    </div>
  </div>
</div>

<!-- Fear & Greed -->
<div class="card">
  <h2>Fear & Greed Index</h2>
  <div id="fear">Loading...</div>

  <div class="row">
    <button id="refreshFearBtn" class="btn btn-tertiary">Fear&Greed å†å–å¾—</button>
    <button id="clearLogBtn" class="btn btn-tertiary">ãƒ­ã‚°æ¶ˆå»</button>
  </div>

  <div id="debugLog" class="debug-box">debug logâ€¦</div>
</div>

<!-- Signal -->
<div class="card">
  <h2>Today Signal</h2>
  <div id="signal">Loading...</div>
</div>

<!-- Newsï¼ˆRSS Readerï¼‰ -->
<div class="card">
  <h2>Newsï¼ˆRSS Reader / ã‚¢ãƒ—ãƒªå†…ã§è¦ç´„è¡¨ç¤ºï¼‰</h2>

  <div class="news-toolbar">
    <button id="refreshNewsBtn">ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–°</button>
    <button id="pickTopBtn">3æœ¬ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>

  <div id="newsStatus" class="news-status">æœªå–å¾—</div>
  <div id="newsList" class="news-list"></div>

  <div class="news-status">
    â€»ã€Œå…¨æ–‡ã‚’èª­ã‚€ã€ã¯ãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ï¼ˆå¤–éƒ¨ãƒšãƒ¼ã‚¸ï¼‰ã€‚ã‚¢ãƒ—ãƒªå†…ã§èª­ã‚ã‚‹ã®ã¯RSSã®è¦ç´„ã¾ã§ã€‚
  </div>
</div>

<!-- noteç”¨ãƒ¡ãƒ¢ -->
<div class="card">
  <h2>noteç”¨ãƒ¡ãƒ¢</h2>
  <textarea id="noteText" rows="10" class="note-area"></textarea>
  <div class="btn-row">
    <button id="genBtn" class="btn btn-primary">ç”Ÿæˆ</button>
    <button id="copyBtn" class="btn btn-secondary">ã‚³ãƒ”ãƒ¼</button>
  </div>
  <div id="copyStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></div>
</div>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
/* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ« ===== */
window.latestFearValue = null;
window.latestFearText = null;
window.newsItems = [];

/* ===== RSSã‚½ãƒ¼ã‚¹ ===== */
const RSS_SOURCES = [
  { category: "Crypto", source: "CoinDesk",      rss: "https://www.coindesk.com/arc/outboundfeeds/rss/" },
  { category: "Crypto", source: "Cointelegraph", rss: "https://cointelegraph.com/rss" },
  { category: "Stocks", source: "CNBC",          rss: "https://www.cnbc.com/id/100003114/device/rss/rss.html" }
];

/* ===== CORSå›é¿ãƒ—ãƒ­ã‚­ã‚· ===== */
function proxiedUrl(url){
  return "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
}

/* ===== Debug log helpers ===== */
function nowStr(){
  const d = new Date();
  return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
}
function logDebug(msg){
  const el = document.getElementById("debugLog");
  if (!el) return;
  el.textContent = `[${nowStr()}] ${msg}\n` + el.textContent;
}

document.addEventListener("DOMContentLoaded", function () {

  // 1) TradingView
  new TradingView.widget({
    container_id: "tv_btc",
    symbol: "BITFLYER:BTCJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  new TradingView.widget({
    container_id: "tv_eth",
    symbol: "BITFLYER:ETHJPY",
    interval: "60",
    theme: "dark",
    style: "1",
    autosize: true,
    studies: ["RSI@tv-basicstudies"]
  });

  // 2) Fear & Greedï¼ˆSwiftã«ä¾é ¼ï¼‰
  loadFearGreed();

  // æ‰‹å‹•å†å–å¾—
  document.getElementById("refreshFearBtn").addEventListener("click", () => {
    logDebug("manual refresh button tapped");
    loadFearGreed();
  });
  document.getElementById("clearLogBtn").addEventListener("click", () => {
    document.getElementById("debugLog").textContent = "debug logâ€¦";
  });

  // 3) noteãƒœã‚¿ãƒ³
  document.getElementById("genBtn").addEventListener("click", generateNoteText);
  document.getElementById("copyBtn").addEventListener("click", copyNoteText);

  // 4) Newsï¼ˆRSSï¼‰
  document.getElementById("refreshNewsBtn").addEventListener("click", refreshNews);
  document.getElementById("pickTopBtn").addEventListener("click", pickTop3);
  refreshNews();

  logDebug("DOMContentLoaded done");
});

/* =========================================================
   Fear & Greedï¼ˆSwift â†’ JSï¼‰
   ========================================================= */

/** SwiftãŒå‘¼ã¶æç”»é–¢æ•° */
function renderFearGreed(value, classification) {
  logDebug(`renderFearGreed called: value=${value}, classification=${classification}`);

  const fearEl = document.getElementById("fear");
  const signalEl = document.getElementById("signal");

  const v = parseInt(value, 10);
  const text = (classification ?? "").toString();

  window.latestFearValue = Number.isFinite(v) ? v : null;
  window.latestFearText = text || null;

  if (!Number.isFinite(v) || !text) {
    fearEl.innerHTML = `<p style="color:red;">Fear data invalid</p>`;
    signalEl.innerHTML = `<p style="color:red;">Signal data invalid</p>`;
    return;
  }

  let color = "#999";
  if (v <= 25) color = "#2ecc71";
  else if (v <= 50) color = "#f1c40f";
  else if (v <= 75) color = "#e67e22";
  else color = "#e74c3c";

  fearEl.innerHTML = `
    <div style="background:${color};color:white;padding:20px;border-radius:12px;font-size:28px;text-align:center;">
      ${v} - ${text}
    </div>
  `;

  let signalText = "";
  if (v <= 25) signalText = "ğŸŸ¢ Opportunityï¼ˆå¸‚å ´ã¯ææ€–å¯„ã‚Šï¼‰";
  else if (v <= 50) signalText = "ğŸŸ¡ Neutralï¼ˆæ§˜å­è¦‹ï¼‰";
  else if (v <= 75) signalText = "ğŸŸ  Greedï¼ˆéç†±æ³¨æ„ï¼‰";
  else signalText = "ğŸ”´ Riskyï¼ˆåˆ©ç¢ºè­¦æˆ’ï¼‰";

  signalEl.innerHTML = `
    <div style="background:${color};color:white;padding:20px;border-radius:12px;font-size:20px;text-align:center;">
      ${signalText}
    </div>
  `;
}

/** HTMLå´ã¯Swiftã«ã€Œå–å¾—ã—ã¦ã€ã¨ä¾é ¼ã™ã‚‹ã ã‘ */
function loadFearGreed() {
  const fearEl = document.getElementById("fear");
  const signalEl = document.getElementById("signal");

  const hasBridge = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.fearGreed);
  logDebug(`loadFearGreed() bridge=${hasBridge}`);

  fearEl.innerHTML = `<p style="color:#aaa;">bridge: ${hasBridge} / requesting...</p>`;
  signalEl.innerHTML = `<p style="color:#aaa;">waiting...</p>`;

  try {
    if (hasBridge) {
      // JS -> Swift
      window.webkit.messageHandlers.fearGreed.postMessage({ action: "fetch" });
      logDebug("posted message to Swift: {action:'fetch'}");
    } else {
      fearEl.innerHTML = `<p style="color:#aaa;">Fear & Greed: waiting for iOS appâ€¦</p>`;
      signalEl.innerHTML = `<p style="color:#aaa;">Signal: waiting for iOS appâ€¦</p>`;
    }
  } catch (e) {
    logDebug("postMessage error: " + String(e));
    fearEl.innerHTML = `<p style="color:red;">Fear load failed: ${String(e)}</p>`;
    signalEl.innerHTML = `<p style="color:red;">Signal load failed: ${String(e)}</p>`;
  }
}

function classifyFear(value) {
  if (value <= 25) return "ææ€–ï¼ˆãƒãƒ£ãƒ³ã‚¹å¯„ã‚Šï¼‰";
  if (value <= 50) return "ã‚„ã‚„ææ€–ã€œä¸­ç«‹";
  if (value <= 75) return "å¼·æ¬²æ°—å‘³ï¼ˆéç†±æ³¨æ„ï¼‰";
  return "å¼·æ¬²ï¼ˆè­¦æˆ’ï¼‰";
}

/* ===== News (RSS) ===== */
function cleanHtmlToText(html){
  if (!html) return "";
  return html
    .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "")
    .replace(/<style[\s\S]*?>[\s\S]*?<\/style>/gi, "")
    .replace(/<\/?[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

async function fetchRssItems(sourceObj, limit = 6){
  const res = await fetch(proxiedUrl(sourceObj.rss), { cache: "no-store" });
  if (!res.ok) throw new Error(`${sourceObj.source} RSS HTTP ${res.status}`);
  const xmlText = await res.text();

  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, "text/xml");

  const items = Array.from(xml.querySelectorAll("item")).slice(0, limit);

  return items.map((it, idx) => {
    const title = (it.querySelector("title")?.textContent || "").trim();
    const link  = (it.querySelector("link")?.textContent || "").trim();

    const descRaw =
      it.querySelector("description")?.textContent ||
      it.querySelector("content\\:encoded")?.textContent ||
      "";

    const desc = cleanHtmlToText(descRaw).slice(0, 240);
    const pubDate = (it.querySelector("pubDate")?.textContent || "").trim();

    return {
      id: `${sourceObj.source}-${idx}-${Date.now()}`,
      category: sourceObj.category,
      source: sourceObj.source,
      title,
      link,
      desc,
      pubDate,
      picked: false,
      memo: ""
    };
  }).filter(x => x.title && x.link);
}

async function refreshNews(){
  const statusEl = document.getElementById("newsStatus");
  const listEl = document.getElementById("newsList");

  statusEl.textContent = "ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦";
  listEl.innerHTML = "";

  try {
    const all = [];
    for (const src of RSS_SOURCES) {
      const items = await fetchRssItems(src, 6);
      all.push(...items);
    }

    all.sort((a,b) => (Date.parse(b.pubDate)||0) - (Date.parse(a.pubDate)||0));

    const memoMap = new Map(window.newsItems.map(x => [x.link, { memo: x.memo, picked: x.picked }]));
    for (const it of all) {
      const old = memoMap.get(it.link);
      if (old) { it.memo = old.memo; it.picked = old.picked; }
    }

    window.newsItems = all;
    renderNews();

    const now = new Date();
    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,"0")}`;
    statusEl.textContent = `å–å¾—å®Œäº†ï¼ˆ${timeStr}ï¼‰ / ${all.length}ä»¶`;

  } catch (e) {
    statusEl.textContent = `å–å¾—å¤±æ•—ï¼š${String(e)}`;
  }
}

function renderNews(){
  const listEl = document.getElementById("newsList");
  listEl.innerHTML = "";

  const displayItems = window.newsItems.slice(0, 10);

  for (const item of displayItems) {
    const wrapper = document.createElement("div");
    wrapper.className = "news-item";

    wrapper.innerHTML = `
      <div class="news-top">
        <span class="badge">${item.category} / ${item.source}</span>
        <label class="news-pick">
          <input type="checkbox" ${item.picked ? "checked" : ""} data-link="${item.link}">
          noteã«å…¥ã‚Œã‚‹
        </label>
      </div>

      <p class="news-title">
        <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
      </p>

      <div class="news-desc">${item.desc ? item.desc : "ï¼ˆè¦ç´„ãªã—ï¼‰"}</div>

      <div class="news-meta">
        <span>${item.pubDate ? item.pubDate : ""}</span>
      </div>

      <textarea class="news-memo" rows="2" placeholder="ã²ã¨ã“ã¨ãƒ¡ãƒ¢ï¼ˆnoteç”¨ï¼‰" data-memo-link="${item.link}">${item.memo || ""}</textarea>
    `;

    listEl.appendChild(wrapper);
  }

  listEl.querySelectorAll('input[type="checkbox"][data-link]').forEach(cb => {
    cb.addEventListener("change", (e) => {
      const link = e.target.getAttribute("data-link");
      const it = window.newsItems.find(x => x.link === link);
      if (it) it.picked = e.target.checked;
    });
  });

  listEl.querySelectorAll('textarea[data-memo-link]').forEach(tx => {
    tx.addEventListener("input", (e) => {
      const link = e.target.getAttribute("data-memo-link");
      const it = window.newsItems.find(x => x.link === link);
      if (it) it.memo = e.target.value;
    });
  });
}

function pickTop3(){
  for (const it of window.newsItems) it.picked = false;

  const crypto = window.newsItems.filter(x => x.category === "Crypto").slice(0, 2);
  const stocks = window.newsItems.filter(x => x.category === "Stocks").slice(0, 1);

  [...crypto, ...stocks].forEach(x => x.picked = true);
  renderNews();

  document.getElementById("newsStatus").textContent = "3æœ¬ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼ˆCrypto2 + Stocks1ï¼‰";
}

/* ===== noteç”Ÿæˆ ===== */
function generateNoteText() {
  const v = window.latestFearValue;
  const t = window.latestFearText;

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");

  const fearLine = (v === null)
    ? "ææ€–æŒ‡æ•°ï¼šå–å¾—ã§ããš"
    : `ææ€–æŒ‡æ•°ï¼š${v}ï¼ˆ${t} / ${classifyFear(v)}ï¼‰`;

  const picked = window.newsItems.filter(x => x.picked).slice(0, 3);

  const newsLines = picked.length
    ? picked.map((n, i) => {
        const memo = n.memo ? `ï¼ˆãƒ¡ãƒ¢ï¼š${n.memo}ï¼‰` : "";
        return `${i+1}. [${n.source}] ${n.title}\n   - ${n.link}\n   - è¦ç´„: ${n.desc}${memo ? "\n   - " + memo : ""}`;
      }).join("\n\n")
    : "ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹æœªé¸æŠï¼šä¸‹ã®Newsã§ã€Œnoteã«å…¥ã‚Œã‚‹ã€ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€3æœ¬ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æŠ¼ã™ï¼‰";

  const text =
`ã€${y}/${m}/${d}ã€‘å¹³æ—¥ãƒ¡ãƒ¢

â–  ãƒãƒ£ãƒ¼ãƒˆæ‰€æ„Ÿï¼ˆ1æ™‚é–“è¶³ï¼‰
ãƒ»BTCï¼š
ãƒ»ETHï¼š

â–  å¸‚å ´å¿ƒç†
${fearLine}

â–  ä¸»è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆ3æœ¬ï¼‰
${newsLines}

â–  ä»Šæ—¥ã®è‡ªåˆ†ãƒ¡ãƒ¢
ãƒ»`;

  document.getElementById("noteText").value = text;
}

async function copyNoteText() {
  const area = document.getElementById("noteText");
  const status = document.getElementById("copyStatus");

  try {
    await navigator.clipboard.writeText(area.value);
    status.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
  } catch (e) {
    area.focus();
    area.select();
    status.textContent = "è‡ªå‹•ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€é¸æŠã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ã­";
  }
}
</script>
</body>
</html>
